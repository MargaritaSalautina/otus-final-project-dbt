








WITH staging AS (
-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    id,
    order_id,
    reason_for_delay

    FROM "postgres"."dbt"."source_order_with_delay"
),

derived_columns AS (

    SELECT

    id,
    order_id,
    reason_for_delay,
    id AS ORDER_WITH_DELAY_KEY,
    'CSV_ORDER_WITH_DELAY'::TEXT AS RECORD_SOURCE

    FROM source_data
),

hashed_columns AS (

    SELECT

    id,
    order_id,
    reason_for_delay,
    ORDER_WITH_DELAY_KEY,
    RECORD_SOURCE,

    DECODE(MD5(NULLIF(UPPER(TRIM(CAST(id AS VARCHAR))), '')), 'hex') AS ORDER_WITH_DELAY_PK,

    DECODE(MD5(COALESCE(NULLIF(UPPER(TRIM(CAST(reason_for_delay AS VARCHAR))), ''), '^^')), 'hex') AS ORDER_WITH_DELAY_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    id,
    order_id,
    reason_for_delay,
    ORDER_WITH_DELAY_KEY,
    RECORD_SOURCE,
    ORDER_WITH_DELAY_PK,
    ORDER_WITH_DELAY_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select
)

SELECT *,
    current_timestamp AS LOAD_DATE,
    current_timestamp AS EFFECTIVE_FROM
FROM staging